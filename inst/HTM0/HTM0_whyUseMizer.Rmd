---
title: Why use Mizer?
output: html_document
---

Mizer is a tool that can be used to simulate a dynamic size spectrum in an marine ecosystem, subject to changes through time, such as fishing pressure. Multiple interacting species and fishing gears can be defined allowing for a range of fisheries management strategy scenarios, and their ecosystem impacts, to be tested.

Below we explore some examples of what can be done using a previously calibrated Mizer model. 

```{r set-up, echo = F,message=F, warning=F}
# by this stage user has already loaded mizerHowTo and opened the Rmd using tutorial("HTM0", extension = "Rmd)
# leaving library for developer knitting
library(mizerHowTo) 

# TODO JB: need to rerun the calibration and post blog before we do the session!
# upgrade params
sim <- upgradeSim(HTM0_sim)
sim@params@linecolour[1:dim(sim@params@species_params)[1]] <- viridis::viridis(dim(sim@params@species_params)[1]) # color gradient of asymptotic sizes

params <- getParams(sim)
effort <- getEffort(sim)

# correct gear params | Why are they wrong in the first place?
gear_params(params)[,c("l25","l50")] <- species_params(params)[,c("l25","l50")]
 # assume the species params numbers are correct

```

### Species Collapse and Recovery in a Heavily Fished Multispecies System

In this example  we will read in a calibrated model for the North Sea, which consists of 12 interacting species and a background resource. All species are predators and prey since they feed according to size-based rules and they encounter each  other. Fishing is applied as a logistic curve by length, matched to the maturity length $l_{50}$ of each species.

More information on how this model was calibrated with historical data can be found in our "mizerHowTo" package (`tutorial("HTM3")`) and in this [blogpost](https://blog.mizer.sizespectrum.org/posts/2021-08-20-a-5-step-recipe-for-tuning-the-model-steady-state/). 

You can take a look at how the modelled species biomasses change through time by running the following:

```{r}
plotlyBiomass(sim, start_time = 1950, end_time = 2018)
# size spectra averaged for the final 5 years
plotlySpectra(sim,time_range = c(2015:2018),power=2)
```

### Examining changes in the community relative to an unfished state 

To be able to examine any changes in the community relative to an unfished state we can re-set effort = 0 and calculate the steady state. 

```{r, eval = T, echo = F, warning=F, message=F}
sim0 <- projectToSteady(params, effort = 0, return_sim = TRUE, t_max = 200)
#  or could set the initial N to this state, would be better? better to set  this up in advance so we dont have to do it here?
```


```{r, warning=F}
plotlyBiomass(sim0)
```

We can compare the current size spectra (averaged over 2015-2019) to the unfished size spectra to assess whether there is any evidence of a size-structured trophic cascade due to fishing.

```{r , code_folding=TRUE, eval = T, echo = T, warning=F}

plot_relative_biomass(sim0, sim, ratio = T)
plot_relative_biomass(sim0, sim)

```

Here we can see the effect of the reduction in large sized individuals of heavily fished species on the other sizes and species in the model, relative to the unfished steady state. 

The abundance of some (but not all) of the smaller to medium sizes of prey are a lot higher  when their larger predators are removed (note the logarithmic scale).

Sprat looks to be much lower.

We can do the same with Biomass to see when, if any, of the species collapse. For simplicity, we use < 0.1 of B/B_unfished as a proxy for a reference point for population collapse. We can add other reference points to this kind of plot, for example a simple rule of thumb for B_msy could be  0.5*B_unfished.

```{r,code_folding=TRUE, eval = T, echo = F, warning=F}

# select the species  (or should we set this up with all species, like plotlyBiomass, should we make these plots in built functions?)

B0 <- getBiomass(sim0)[idxFinalT(sim0), ]
Brel <- melt(sweep(getBiomass(sim), 2, B0, "/"))

select_species = "Sprat"

Brel_select <- Brel %>%
  filter(sp == select_species & time >= 1950) 


plot_Brel<-ggplot(Brel_select)+ geom_line(aes(x=time,y=value), size = 1) + 
ggpubr::theme_pubr() + 
geom_hline(yintercept = 0.1, linetype=1, colour="red", size=0.75) +
  geom_hline(yintercept = 0.5, linetype=1, colour="steel blue", size=0.75) +
labs(x="",y="Relative Biomass") +
scale_y_continuous(limits = c(0,max(Brel_select$value)))

plot_Brel<- plot_Brel  +
    annotate("text", x = 1951, y = 0.1+0.05, label = "Blim", color = "red") +
    annotate("text", x = 1951, y = 0.5+0.05, label = "Bmsy", color = "steel blue") +
    annotate("text", x = 2015, y = max(Brel_select$value), 
             label = select_species, color = "black") 

plot_Brel

# which years < 0.1 B_unfished

Brel_select <- Brel %>%
    filter(sp == "Sprat" & time >= 1950) %>%
    mutate(collapsed = value < 0.1)

ggplot(Brel_select, aes(x = time, y = value, fill = collapsed)) +
    geom_col(position = "identity") +
    geom_hline(yintercept = 0.1, colour = "dark grey", size = 0.75) +
    scale_fill_manual(values = alpha(c("blue", "red"), .3)) +
    ggpubr::theme_pubr()

```


### Projecting future recovery scenarios 

We may now wish to explore the potential recovery of the larger species and sizes in the system. To do this we set  up another scenario, where the model starts with the last time step of the fished scenario.

First let's take a look at what the model has used in the historical period (from ICES stock assessments).

```{r, warning=FALSE, echo = FALSE}
plot_dat <- melt(getEffort(sim))  %>% filter(time >= 1980)
colnames(plot_dat)[2] <- "Species"
legend_levels <- intersect(names(sim@params@linecolour), plot_dat$Species)

ggplot(plot_dat) + 
geom_line(aes(x = time, y = value, colour = Species), size = 1) + 
  scale_x_continuous(name = "Year") +
  scale_y_continuous(name = "Effort") +
  scale_color_manual(values = sim@params@linecolour[legend_levels]) +
  theme(legend.key = element_rect(fill = "white"))


```

The species' maximum fishing mortality rates (which we call for convenience effort) for Cod and Saithe have declined but are not as low as what would be in line with single-species "Fmsy" (a reference level of fishing  deemed sustainable from  single-species stock assessements) and the fishing mortality rate for Sprat and Dab is very high. 

The effort values in 2018 were


```{r, echo= FALSE}
current_effort <- getEffort(sim)["2018", ]
knitr::kable(t(current_effort), caption = "Current effort",)

```


Let's start a new simulation that begins with the effort from 2018 and projects forward for 50 years.
We will apply a linear reduction in effort for a selected species to a target value (here assumed for simplicity to be 0.2 with effort expressed in terms of the species' fishing mortality rate for fully selected sizes).

To do this we need to work with the effort array (time x gear) to enable changes in effort through time, for this scenario. Here we have a 'gear' for each species, since effort in this case were annual single-species fishing mortality estimates.


```{r, echo = FALSE}

sim_status_quo<-project(params,initial_n = sim@n["2018",,], initial_n_pp = sim@n_pp["2018",],effort=current_effort,t_max = 50)

# proj_effort<-sim_status_quo@effort

proj_effort <- matrix(current_effort, nrow = 51, ncol = 12, byrow = TRUE)
dimnames(proj_effort) <- list(time = 2019:2069,
                              gear = unique(gear_params(params)$gear))


# sp_idx <- which(species_params(params)$species == "Sprat")

target<-0.2
select_species="Sprat"
# reach target by 10 years
proj_effort[1:10, select_species] <- 
    seq(from = proj_effort[1, select_species], to = target, length = 10)

# then hold at target
proj_effort[11:51, select_species] <- target

# check it
proj_effortDf <- data.frame("Time" = rownames(proj_effort), "Effort" = proj_effort[,select_species])
proj_effortDf_short <- proj_effortDf[c(1:13,49:51),] # looks nicer but keeping long version
flextable::regulartable(proj_effortDf_short) %>% flextable::set_caption("Projected effort on Sprat")

# run the simulation forward, using the 2018 abundances as initial values


# sim_scen<-project(params,initial_n = sim@n["2018",,], initial_n_pp = sim@n_pp["2018",],effort=proj_effort,t_max = 50)

params_status_quo <- setInitialValues(params, sim)
sim_scen <- project(params_status_quo, effort = proj_effort, t_max = 50)


# plot change in biomass relative to 2018 values

plotlyBiomass(sim_scen)

B_current <- getBiomass(sim_scen)[1, ]

Brel_scen <- melt(sweep(getBiomass(sim_scen), 2, B_current, "/"))
colnames(Brel_scen)[2] <- "Species"
legend_levels <- intersect(names(sim_scen@params@linecolour), Brel_scen$Species)

ggplot(Brel_scen) + 
  geom_line(aes(x = time,y = value,color = Species), size = 1) + 
  geom_hline(yintercept = 1, linetype = 1, colour = "grey", size = 0.75) +
  scale_y_continuous(name = "Relative biomass") +
  scale_color_manual(values = sim@params@linecolour[legend_levels]) +
  theme(legend.key = element_rect(fill = "white"))


```

We can see that when we reduce fishing on Sprat it increases the biomass of this species but also affects the biomass of other species in the community.

Are any species collapsed still?

```{r, echo = FALSE}

# Brel_ref <- melt(sweep(getBiomass(sim_scen), 2, B0, "/"))

Brel_ref <- Brel_scen  %>% mutate(collapsed = value < 0.1)

ggplot(Brel_ref, aes(x = time, y = value, fill = collapsed)) +
    geom_col(position = "identity") +
    geom_hline(yintercept = 0.1, colour="red", size = 0.75) +
    geom_hline(yintercept = 0.5, colour="dark grey", size = 0.75) +
    scale_fill_manual(values = alpha(c("blue", "red"), .3)) +
    facet_wrap(vars(Species)) +
    theme_void()
```


### Exploration options - break into smaller groups:

1. Cut and paste the above code chunks and edit it to explore your own fishing scenarios.
```{r}

```

2. Alter some of of the model parameters to see how this affects the scenario outcomes.
```{r}

```

3. Using the unfished sim object examine the effects of adding a species to the model

```{r}

```



## Further Exploration (Optional)

### Example 2: Set up an explore a time-varying fishing scenario

We could examine how this fish community would have responded if there had been a completely different historical development of fishing fleets over time.

Here we will examine how some commonly used community indicators of the ecosystem effects of fishing change in response to this scenario.

 We can alter the  fishing parameters using a function called *gear_params()* and by changing the *effort* input. 
 
 Let's take a look at the fishing parameters. Note that the gears in the above model were already setup to be species-specific.
 
```{r, echo = FALSE}
# look at the gear set up:
knitr::kable(gear_params(params), caption = "gear parameters")
```
 
 
We can group these species  together according to the gears they are caught by.  Let's imagine a big super trawler. 

```{r}
# allocate species to gear types
gear_params(params)$gear <- c("super_trawler")
```


Note that catchability is set to 1. This is because the fishing "effort" was here assumed to be the fishing mortality rate of fully selected sizes (see here [setFishing](https://sizespectrum.org/mizer/reference/setFishing.html?q=set%20fishing)).

The previous effort won't work with these new gears, as it is gear x time. We only have a single gear now, so this is easier to set up.

```{r}

params <- setFishing(params, initial_effort = 1.5)

```


```{r}
sim_trawler <- projectToSteady(params, effort = 1.5, return_sim = TRUE, t_max = 200)

plotlySpectra(sim_trawler)

plotlyBiomass(sim_trawler)

plotFMort(sim_trawler)

getProportionOfLargeFish(sim = sim_trawler)
```



### Example 3: Adding a variable environment

```{r}

```


Now we can look at probability of collapse.
